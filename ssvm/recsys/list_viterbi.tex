Given a trained HMM, there are more than one approaches to get a list of top scored sequences of length $l$, 
\eg algorithms extend the classic Viterbi algorithm and keep tracking the score differences between sequences 
that diverge from the best scored sequence and then merge back~\cite{seshadri1994list,nill1995list};
or algorithms that make use of the information computed by the forward-backward procedure~\cite{rabiner1989tutorial}
and keep partitioning the set of all possible sequences of length $l$, computing the best scored sequence in all the partitions
and tracking the next best scored sequence~\cite{nilsson2001sequentially}.

\section{Basics}
\label{sec:basic}

We found that by leveraging information computed by the forward-backward procedure, similar to the approach proposed in~\cite{nilsson2001sequentially},
it is possible to unify these approaches.

Consider a hidden Markov model with $m$ random variables $X_1, \dots, X_m$ and $m$ observed variables $Y_1, \dots, Y_m$
where the distribution of $Y_t$ is determined by $X_t$.
We denote $X = \{X_1, \dots, X_m\}$ and $Y = \{Y_1, \dots, Y_m\}$, 
$\x = x_{1:m}$ and $\y = y_{1:m}$ are values of $X$ and $Y$ respectively.
The joint probability 
\begin{equation}
\label{eq:joint}
P(\x, \y) = P(x_1) \prod_{t=2}^m P(x_t |x_{t-1}) \prod_{t=1}^m P(y_t |x_t).
\end{equation}

We note that the forward-backward procedure can yield the following terms 
\begin{align}
\label{eq:basic}
f_t(s)           &= \max_{\{\x|x_t = s\}} P(\x, \y) \\
f_{t,t+1}(s, s') &= \max_{\{\x|x_t = s, x_{t+1} = s'\}} P(\x, \y)
\end{align}
and the best scored sequence $\x^1$ can be identified as
\begin{align*}
(x_1^1, x_2^1) = \argmax_{(s, s')} f_{1,2}(s, s') \\
x_t^1 = \argmax_{s} f_{t-1, t}(x_{t-1}^1, s), t > 2
\end{align*}

\begin{lemma}
\label{lemma1}
Let $E$ denote a set of sequences $E = \{\x |x_1 = x_1^*, \dots, x_i = x_i^*\}$ and
$x_t = \argmax_{s} f_{t-1, t}(x_{t-1}, s), \, t = i+1,\dots,m$, 
we claim that if $x_{1:k}, k > i$ is the best scored \textbf{prefix} (partial sequence of length $k$) over $E$, 
then $x_{1:k+1}$ is also the best scored \textbf{prefix} (partial sequence of length $k+1$) over $E$,
assuming no ties exists.
\end{lemma}

\begin{proof}
This lemma can be easily proved by contradiction.
Let $s^* = \argmax_{s} f_{k, k+1}(x_k, s)$, so $f_{k,k+1}(x_k, s^*) > f_{k,k+1}(x_k, s), \, \forall s \ne s^*$.
Assuming $(x_1:k, x_{k+1}^*)$ is the best scored \emph{prefix} (partial sequence of length $k+1$) over $E$ and $x_{k+1}^* \ne s^*$,
then $f_{k,k+1}(x_k, x_{k+1}^*) > f_{k,k+1}(x_k, s^*)$ according to Eq.~(\ref{eq:basic}), 
which contradicts with the fact that $f_{k,k+1}(x_k, s^*) > f_{k,k+1}(x_k, s), \, \forall s \ne s^*$.
\end{proof}

\begin{theorem}
\label{theorem1}
Let $E$ denote a set of sequences $E = \{\x |x_1 = x_1^*, \dots, x_i = x_i^*\}$ and
$x_t = \argmax_{s} f_{t-1, t}(x_{t-1}, s), \, t = i+1,\dots,m$, 
then $(x_1^*,\dots,x_i^*, x_{t:m}) = \argmax_{\x \in E} P(\x,\y)$.
\end{theorem}

\begin{proof}
According to Eq.~(\ref{eq:basic}), the best scored \emph{prefix} (partial sequence of length $i+1$) over $E$ is $(x_1^*,\dots,x_i^*,x_{i+1}^*)$
where $x_{i+1}^* = \argmax_{s} f_{i, i+1}(x_i^*, s)$.
By Lemma~\ref{lemma1} and mathematical induction, the result follows.
\end{proof}

\begin{lemma}
\label{lemma2}
Let $E$ denote a set of sequences $E = \{\x |x_i = x_i^*, \dots, x_m = x_m^*\}$ and
$x_t = \argmax_{s} f_{t, t+1}(s, x_{t+1}), \, t = i-1 \downto 1$, 
we claim that if $x_{k:m}, k < i$ is the best scored \textbf{suffix} (partial sequence of length $k$) over $E$, 
then $x_{k-1:m}$ is also the best scored \textbf{suffix} (partial sequence of length $k+1$) over $E$,
assuming no ties exists.
\end{lemma}

\begin{proof}
This lemma can be proved in the same manner as Lemma~\ref{lemma1} (by contradiction).
Let $s^* = \argmax_{s} f_{k-1, k}(s, x_k)$, so $f_{k-1,k}(s^*, x_k) > f_{k-1,k}(s, x_k), \, \forall s \ne s^*$.
Assuming $(x_{k-1}^*, x_{k:m})$ is the best scored \emph{suffix} (partial sequence of length $k+1$) over $E$ and $x_{k-1}^* \ne s^*$,
then $f_{k-1,k}(x_{k-1}^*, x_k) > f_{k-1,k}(s^*, x_k)$ according to Eq.~(\ref{eq:basic}), 
which contradicts with the fact that $f_{k-1,k}(s^*, x_k) > f_{k-1,k}(s, x_k), \, \forall s \ne s^*$.
\end{proof}

\begin{theorem}
\label{theorem2}
Let $E$ denote a set of sequences $E = \{\x |x_i = x_i^*, \dots, x_m = x_m^*\}$ and
$x_t = \argmax_{s} f_{t, t+1}(s, x_{t+1}), \, t = i-1 \downto 1$, 
then $(x_{1:i-1},x_i^*,\dots,x_m^*) = \argmax_{\x \in E} P(\x,\y)$.
\end{theorem}

\begin{proof}
According to Eq.~(\ref{eq:basic}), the best scored \emph{suffix} (partial sequence of length $i+1$) over $E$ is $(x_{i-1}^*,x_i^*,\dots,x_m^*)$
where $x_{i-1}^* = \argmax_{s} f_{i-1, i}(s, x_i^*)$.
By Lemma~\ref{lemma2} and mathematical induction, the result follows.
\end{proof}


\section{Find top-k scored sequences}
\label{sec:topk}

Given the best, second best, $\cdots$, $k$-th best sequences, how can we find the $k\!+\!1$-th best sequence?

Consider the set of sequences 
\begin{equation}
\label{eq:d}
D = \{\x |x_i \notin \mathcal{X}'_i, x_{i+1} = x_{i+1}^k, \dots, x_m = x_m^k\},
\end{equation}
we can partition $D$ as 
\begin{equation}
\label{eq:dj}
D_j = \{\x |x_j \notin \bar{\mathcal{X}}_j, x_{j+1} = x_{j+1}^k, \dots, x_m = x_m^k \}, \, \forall j=1,\dots,i
\end{equation}
where 
\begin{equation*}
\bar{\mathcal{X}}_k = \begin{cases}
                       \mathcal{X}'_j \cup \{x_j^k\}, & j = i \\
                       \{x_j^k \}, & j < i
                      \end{cases}
\end{equation*}

We note that the joint probability~(\ref{eq:joint}) can be expressed as~\cite{nilsson2001sequentially}:
\begin{equation}
P(\x, \y) = \frac{\prod_{t=1}^{m-1} f_{t,t+1}(x_t, x_{t+1})} {\prod_{t=2}^{m-1} f_t(x_t)}.
\end{equation}

We also have the following \emph{max-consistency} from Eq.~(\ref{eq:basic}):
\begin{align}
\label{eq:consistency}
\max_{x_{t+1}} f_{t,t+1}(x_t, x_{t+1}) & = f_t(x_t) \\
\max_{x_t} f_{t,t+1}(x_t, x_{t+1}      & = f_{t+1}(x_{t+1})
\end{align}

\begin{lemma}
\label{lemma3}
Let $E$ denote a set of sequences $E = \{\x |x_1 = x_1^*, \dots, x_i = x_i^*\}$, then
\begin{equation*}
\max_{\x \in E} P(\x,\y) = \frac{\prod_{t=1}^{i-1} f_{t,t+1}(x_t^*, x_{t+1}^*)} {\prod_{t=2}^{i-1} f_t(x_t^*)}
\end{equation*}
\end{lemma}

\begin{proof}
Let $x_t^* = \argmax_{s} f_{t-1, t}(x_{t-1}, s), \, t = i\!+\!1,\dots,m$, 
then $(x_1^*,\dots,x_m^*) = \argmax_{\x \in E} P(\x,\y)$ by Lemma~\ref{lemma1},
and $f_{t,t+1}(x_t^*, x_{t+1}^*) = f_{t}(x_t^*), \, t = i\!+\!1,\dots,m\!-\!1$ by max-consistency~(\ref{eq:consistency}),
as a results,
\begin{align*}
\max_{\x \in E} P(\x,\y) &= P((x_1^*,\dots,x_m^*), \y) \\
&= \frac{\prod_{t=1}^{m-1} f_{t,t+1}(x_t^*, x_{t+1}^*)} {\prod_{t=2}^{m-1} f_t(x_t^*)} %\\
%= \frac{\prod_{t=1}^{i-1} f_{t,t+1}(x_t^*, x_{t+1}^*)} {\prod_{t=2}^{i-1} f_t(x_t^*)} 
%  \frac{\prod_{t=i}^{m-1} f_{t,t+1}(x_t^*, x_{t+1}^*)} {\prod_{t=i}^{m-1} f_t(x_t^*)} \\
= \frac{\prod_{t=1}^{i-1} f_{t,t+1}(x_t^*, x_{t+1}^*)} {\prod_{t=2}^{i-1} f_t(x_t^*)} \cdot
  \prod_{t=i}^{m-1} \frac{f_{t,t+1}(x_t^*, x_{t+1}^*)} {f_t(x_t^*)}                   %\\
= \frac{\prod_{t=1}^{i-1} f_{t,t+1}(x_t^*, x_{t+1}^*)} {\prod_{t=2}^{i-1} f_t(x_t^*)}.
\end{align*}
\end{proof}

\begin{lemma}
\label{lemma4}
Let $E$ denote a set of sequences $E = \{\x |x_i = x_i^*, \dots, x_m = x_m^*\}$ and
\begin{equation*}
\max_{\x \in E} P(\x,\y) = \frac{\prod_{t=i}^{m-1} f_{t,t+1}(x_t^*, x_{t+1}^*)} {\prod_{t=i+1}^{m-1} f_t(x_t^*)}
\end{equation*}
\end{lemma}

\begin{proof}
Let $x_t^* = \argmax_{s} f_{t, t+1}(s, x_{t+1}), \, t = i\!-\!1 \downto 1$, 
then $(x_1^*,\dots,x_m^*) = \argmax_{\x \in E} P(\x,\y)$ by Lemma~\ref{lemma2},
and $f_{t,t+1}(x_t^*, x_{t+1}^*) = f_{t+1}(x_{t+1}^*),\,t = i\!-\!1 \downto 1$ by max-consistency~(\ref{eq:consistency}),
as a results,
\begin{align*}
\max_{\x \in E} P(\x,\y) &= P((x_1^*,\dots,x_m^*), \y) \\
&= \frac{\prod_{t=1}^{m-1} f_{t,t+1}(x_t^*, x_{t+1}^*)} {\prod_{t=2}^{m-1} f_t(x_t^*)} %\\
%= \frac{\prod_{t=1}^{i-1} f_{t,t+1}(x_t^*, x_{t+1}^*)} {\prod_{t=2}^{i} f_t(x_t^*)} 
%  \frac{\prod_{t=i}^{m-1} f_{t,t+1}(x_t^*, x_{t+1}^*)} {\prod_{t=i+1}^{m-1} f_t(x_t^*)} \\
= \prod_{t=1}^{i-1} \frac{f_{t,t+1}(x_t^*, x_{t+1}^*)} {f_{t+1}(x_{t+1}^*)}  \cdot
  \frac{\prod_{t=i}^{m-1} f_{t,t+1}(x_t^*, x_{t+1}^*)} {\prod_{t=i+1}^{m-1} f_t(x_t^*)} 
= \frac{\prod_{t=i}^{m-1} f_{t,t+1}(x_t^*, x_{t+1}^*)} {\prod_{t=i+1}^{m-1} f_t(x_t^*)}.
\end{align*}
\end{proof}

\begin{lemma}
\label{lemma5}
Suppose $\x^k = \argmax_{\x \in D} P(\x,\y)$ where $D$ is a set defined in Eq.~(\ref{eq:d}),
then we have
\begin{equation*}
\max_{\x \in D} P(\x,\y) = \frac{\prod_{t=1}^{j-1} f_{t,t+1}(x_t^k, x_{t+1}^k)} {\prod_{t=2}^{j-1} f_t(x_t^k)},
\, j = i, \dots, m.
\end{equation*}
\end{lemma}

\begin{proof}
Let $D' = \{\x |x_1 = x_1^k, \dots, x_j = x_j^k \}$ for any $j \ge i$,
since $D' \subset D$, we have
\begin{equation*}
\max_{\x \in D'} P(\x,\y) \le \max_{\x \in D} P(\x,\y).
\end{equation*}
Furthermore, as $\x^k \in D'$ and $\x^k = \argmax_{\x \in D} P(\x,\y)$,
we have,
\begin{equation*}
\max_{\x \in D'} P(\x,\y) \ge P(\x^k,\y) \ge \max_{\x \in D} P(\x,\y),
\end{equation*}
Thus, we have $\max_{\x \in D'} P(\x,\y) = \max_{\x \in D} P(\x,\y)$,
then by Lemma~\ref{lemma3}
\begin{equation*}
\max_{\x \in D} P(\x,\y) = \max_{\x \in D'} P(\x,\y) 
= \frac{\prod_{t=1}^{j-1} f_{t,t+1}(x_t^k, x_{t+1}^k)} {\prod_{t=2}^{j-1} f_t(x_t^k)},
\, j = i, \dots, m.
\end{equation*}
\end{proof}

\begin{lemma}
\label{lemma6}
Suppose $\x^k = \argmax_{\x \in D} P(\x,\y)$ where $D$ is a set defined in Eq.~(\ref{eq:d}),
then we have
\begin{equation*}
\max_{\x \in D} P(\x,\y) = \frac{\prod_{t=j}^{m-1} f_{t,t+1}(x_t^k, x_{t+1}^k)} {\prod_{t=j+1}^{m-1} f_t(x_t^k)},
\, j = 1, \dots, i.
\end{equation*}
\end{lemma}

\begin{proof}
Let $D' = \{\x |x_j = x_j^k, \dots, x_m = x_m^k \}$ for any $j \le i$,
since $D' \subset D$, we have
\begin{equation*}
\max_{\x \in D'} P(\x,\y) \le \max_{\x \in D} P(\x,\y).
\end{equation*}
Furthermore, as $\x^k \in D'$ and $\x^k = \argmax_{\x \in D} P(\x,\y)$,
we have,
\begin{equation*}
\max_{\x \in D'} P(\x,\y) \ge P(\x^k,\y) \ge \max_{\x \in D} P(\x,\y),
\end{equation*}
Thus, we have $\max_{\x \in D'} P(\x,\y) = \max_{\x \in D} P(\x,\y)$,
then by Lemma~\ref{lemma4}
\begin{equation*}
\max_{\x \in D} P(\x,\y) = \max_{\x \in D'} P(\x,\y) 
= \frac{\prod_{t=j}^{m-1} f_{t,t+1}(x_t^k, x_{t+1}^k)} {\prod_{t=j+1}^{m-1} f_t(x_t^k)},
\, j = 1, \dots, i.
\end{equation*}
\end{proof}

\begin{theorem}
\label{theorem3}
Suppose $\x^k = \argmax_{\x \in D} P(\x,\y)$ where $D$ is a set defined in Eq.~(\ref{eq:d}),
then we have
\begin{equation*}
\max_{\x \in D_j} P(\x,\y) 
= \frac{\max_{s \notin \bar{\mathcal{X}}_j} f_{j-1,j}(x_j^k,s)} {f_{j-1,j}(x_j^k,x_{j+1}^k)}
  \cdot \max_{\x \in D} P(\x,\y),
\end{equation*}
where $D_j$ is defined in Eq.~(\ref{eq:dj}). 
\end{theorem}

\begin{proof}
We can express $D_j$ as 
$D_j = \cup_{s |s \notin \bar{\mathcal{X}}_j} \{\x |x_1 = x_1^k, \dots, x_{j-1} = x_{j-1}^k, x_j = s\}$,
by Lemma~\ref{lemma1}, Lemma~\ref{lemma3} and Lemma~\ref{lemma5}, we have
\begin{align*}
&\max_{\x \in D_j} P(\x,\y) \\
&= \frac{\prod_{t=1}^{j-2} f_{t,t+1}(x_t^k,x_{t+1}^k)} {\prod_{t=2}^{j-1} f_t(x_t^k)}
   \cdot \max_{s \notin \bar{\mathcal{X}}_j} f_{j-1,j}(x_{j-1}^k, s)
~~\text{(by Lemma~\ref{lemma1} and Lemma~\ref{lemma3})} \\
&= \frac{\max_{s \notin \bar{\mathcal{X}}_j} f_{j-1,j}(x_j^k,s)} {f_{j-1,j}(x_j^k,x_{j+1}^k)}
   \cdot \max_{\x \in D} P(\x,\y)
~~\text{(by Lemma~\ref{lemma5})}
\end{align*}
\end{proof}

\begin{theorem}
\label{theorem4}
Suppose $\x^k = \argmax_{\x \in D} P(\x,\y)$ where $D$ is a set defined in Eq.~(\ref{eq:d}), % should use another definition of D (suffix)
then we have
\begin{equation*}
\max_{\x \in D_j} P(\x,\y) 
= \frac{\max_{s \notin \bar{\mathcal{X}}_j} f_{j,j+1}(s, x_{j+1}^k)} {f_{j,j+1}(x_j^k,x_{j+1}^k)}
  \cdot \max_{\x \in D} P(\x,\y),
\end{equation*}
where $D_j$ is defined in Eq.~(\ref{eq:dj}).  % should use another definition of Dj (suffix)
\end{theorem}

\begin{proof}
We can express $D_j$ as 
$D_j = \cup_{s |s \notin \bar{\mathcal{X}}_j} \{\x |x_j = s, x_{j+1} = x_{j+1}^k, \dots, x_m = x_m^k\}$,
by Lemma~\ref{lemma2}, Lemma~\ref{lemma4} and Lemma~\ref{lemma6}, we have
\begin{align*}
&\max_{\x \in D_j} P(\x,\y) \\
&= \frac{\prod_{t=j+1}^{m-1} f_{t,t+1}(x_t^k,x_{t+1}^k)} {\prod_{t=j+1}^{m-1} f_t(x_t^k)}
   \cdot \max_{s \notin \bar{\mathcal{X}}_j} f_{j,j+1}(s, x_{j+1}^k)
~~\text{(by Lemma~\ref{lemma2} and Lemma~\ref{lemma4})} \\
&= \frac{\max_{s \notin \bar{\mathcal{X}}_j} f_{j,j+1}(s, x_{j+1}^k)} {f_{j,j+1}(x_j^k,x_{j+1}^k)}
   \cdot \max_{\x \in D} P(\x,\y)
~~\text{(by Lemma~\ref{lemma6})}
\end{align*}
\end{proof}
